# asterisk-changenumber-script
Bash script for Asterisk to change number on Cisco and Yealink desktop phones automaticaly.

Допустим есть кол центр, в нем работают операторы. У каждого оператора свой номер телефона который выдан ему при поступлении на работу.
Если опрераторы перемещаются по офисе, меняют свои рабочие места. То им нужно менять номер телефона, чтобы не пропадала статистика. 

Исходные данные:
* Кол центр на голом Asterisk
* Аппаратные телефоны Cisco SPA303 и Yealink T20/T21
 
У этого решения есть минусы:

На машине где работает Asterisk, должен находится DHCP и TFTP сервер, хотя по идее эти сервисы можно и нужно перенести на другой сервер (ВМ). А к каталогу TFTP настроить доступ с Asterisk сервера по NFS.
Если номер который вводит оператор во время запуска скрипта активен на другом телефоне, то есть по нему ведется разговор, смена номера на служебный [60X] в таком случае произойдет только после завершения разговора на этом телефоне. Незнаю почему так, когда трубка ложится произойдет перезагрузка.
Периодически телефоны Cisco теряют регистрацию на Asterisk, из за чего скрипт по смене внутреннего номера может не запускаться, так как Asterisk не видит активность телефона из за потерянной регистрации. Есть специальная функция "Present" может перерегистрировать телефон пример использования которой можно увидеть на FreePBX или на профильных форумах.
 
Как использовать скрипт, вставляем в свой диалплан код вызова нашего скрипта: 

exten => _557XXX/_[126]XX,1,Answer()

 same => n,PauseQueueMember(,SIP/${CALLERID(num)});
 
 same => n,AGI(confgen.sh,${CHANNEL(uri)},${EXTEN:3},${CALLERID(num)})
 
 same => n,Hangup()

Описание кода вызова:
557 - если набрать 557, будет инициирован процесс смены активного номера на аппаратном телефоне
XXX - номер оператора который  заступил на смену
PauseQueueMember - приостанавливаем прием звонков на номер который активируются, чтобы потом по кнопке DND включить прием звонков.
AGI(confgen.sh) - Вызываем  bash скрипт по смене номера
Hangup - ложим трубку


Клонируем репозиторий в /usr/bin/confgen.sh или /opt/confgen.sh:

git clone https://github.com/almsys/asterisk-changenumber-script.git

Как работает скрипт:

Веденный номер оператора проверяется на активность в Asterisk, если он уже установлен на каком либо аппарате, находим этот аппарат по IP адресу и меняем на нем номер из диапазона 600-602. Номера на 60X - это такие неиспользуемые временные номера, которые устанавливаются на телефон.
Далее проверяются модели телефонов, в зависимости от этого, запускается генерация конфигурационного файла настроек с введенным номером оператора и последующей перезагрузкой аппаратов.
после перезагрузки телефон проверяет на TFTP сервере конфиг настроек, и если он изменился, идет загрузка его в телефон.

